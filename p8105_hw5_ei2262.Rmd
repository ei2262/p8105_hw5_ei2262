---
title: "Homework 5"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(broom)
```

# Problem 1

```{r}
list.files(path="./data", pattern=NULL, all.files=FALSE,
    full.names=FALSE)
```


# Problem 2

### Raw Dataset

```{r}
urlfile="https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"

post_homicide = read_csv(url(urlfile))
```
The raw dataset `post_homicide` includes `r ncol(post_homicide)` columns and `r nrow(post_homicide)` rows. The columns include reported date of homicide, location of the killing, whether an arrest was made or not, and basic demographics about each victim. Demographic information collected include the victims name, age, race, and sex. Information collected about the location of the killing include the city, state, and geographic coordinates (longitudinal and latitudinal coordinates).

#### Creating `city_state` variable and summarizing total number of homicides and unsolved homicides
```{r}
post_homicide =
  post_homicide %>% 
  mutate(city_state = paste(city, state, sep=", "))

total_homicides = post_homicide %>% 
  group_by(city_state) %>% 
  summarize(
        total_homicides = n())

unsolved_homicides = post_homicide %>% 
  group_by(city_state) %>% 
  filter(disposition %in% c("Closed without arrest", "Open/No arrest")) %>% 
  summarize(
    unsolved_homicides = n())

output = merge(total_homicides,unsolved_homicides,by=c("city_state"))
knitr::kable(output, col.names = c("City, State", "Total Homicides", "Unsolved Homicides"))
```

#### `prop.test` of Baltimore,MD
```{r}
baltimore_post = 
  prop.test(x=1825, n=2827, p = NULL, alternative = "two.sided", conf.level = 0.95, correct = TRUE) %>% 
  tidy() %>% 
  select(estimate, conf.low, conf.high)

knitr::kable(baltimore_post, digits = 3)
```

#### `prop.test` for each city in the dataset
```{r}
each_city = output %>% 
  mutate(
    result = map2(output$unsolved_homicides, output$total_homicides, prop.test),
    result = map(result, tidy),
    result = map(result, ~select(.x, estimate, conf.low, conf.high))) %>% 
  unnest(cols = c(result))

knitr::kable(each_city, digits = 3)
```

#### Plot that shows the estimates and CIs for each city
```{r}
each_city %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate, color = city_state)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.4) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90)) +
  labs(
    title = "Proportion of Unsolved Homicides in The U.S.",
    x = "City, State",
    y = "Estimated Proportions"
  )

```

# Problem 3

#### Generating 5000 datasets with fixed design elements (n=30, sigma = 5, mu = 0) and running `t.test`
```{r}
set.seed(1)

new_datasets = map(1:5000, ~ rnorm(n = 30, mean = 0, sd = 5))

ttest_datasets = 
  map(new_datasets, t.test) %>% 
  map(tidy) %>% 
  map(~select(.x, estimate, p.value)) %>%
  as.data.frame() %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "values") 
    
ttest_datasets[2, "parameter"] <- "p.value.0"
ttest_datasets[1, "parameter"] <- "estimate.0"

ttest_datasets
```

#### Generating 5000 datasets with fixed design elements (n=30, sigma = 5) and multiple mu values

```{r, eval = FALSE}
set.seed(2)

multi_datasets = 
  tibble(mu = c(1,2,3,4,5,6)) %>% 
  mutate(
    output_lists = map(.x = mu, ~rerun(5000, rnorm(n=30, mean = .x, sd = 5)))) %>%
  unnest(output_lists)

multi_dataset = multi_datasets %>% 
  pull(output_lists) %>% 
  lapply(t.test) %>% 
  map(tidy) %>%
  map(~select(.x, estimate, p.value)) %>% 
  as.data.frame() %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "values") 
multi_dataset[2, "parameter"] <- "p.value.0"
multi_dataset[1, "parameter"] <- "estimate.0"

multi_dataset["mu"] = rep(c(1,2,3,4,5,6),each=10000)

```

##### Plot 1: Proportion of times the null was rejected

```{r}
multi_plotone = multi_dataset %>% 
  mutate(parameter = sub("\\..*[0-9999]", "", parameter),
         parameter = recode(parameter, p = "p_value")) %>% 
  filter(grepl("^p", parameter)) %>% 
  filter(values > 0.05) %>% 
  add_count(mu,parameter) %>% 
  ggplot(aes(x = mu)) +
  geom_bar() +
  labs(title = "Proportion of times null was rejected vs. true value of mean",
       x = "true mean", 
       y = "proportion of times null was rejected")

multi_plotone
```

